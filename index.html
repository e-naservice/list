<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    
    <meta property="og:title" content="åŠ ç›Ÿåº—ä¸€è¦§">
    <meta property="og:description" content="ãŠå¾—ãªåŠ ç›Ÿåº—ã‚’æ¤œç´¢ã§ãã‚‹ã‚¢ãƒ—ãƒªã§ã™ã€‚">
    <meta property="og:type" content="website">

    <title>åŠ ç›Ÿåº—ä¸€è¦§</title>

    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bgBase: '#fff7e4',
                        primary: '#c5a178',
                        textMain: '#5d4037',
                        textLight: '#8d7b75',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        popIn: {
                            '0%': { opacity: '0', transform: 'scale(0.98)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        body { 
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; 
            background-color: #fff7e4;
            color: #5d4037;
            -webkit-font-smoothing: antialiased;
            overscroll-behavior-y: none;
            /* ã‚¿ãƒƒãƒ—æ™‚ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆè‰²ã‚’ç„¡åŠ¹åŒ– */
            -webkit-tap-highlight-color: transparent;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .coupon-ticket {
            background: #ffffff;
            position: relative;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05));
            clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 95% 95%, 90% 100%, 85% 95%, 80% 100%, 75% 95%, 70% 100%, 65% 95%, 60% 100%, 55% 95%, 50% 100%, 45% 95%, 40% 100%, 35% 95%, 30% 100%, 25% 95%, 20% 100%, 15% 95%, 10% 100%, 5% 95%, 0% 100%);
            padding-bottom: 30px; 
        }
        
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .color-transition { transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; }

        /* ã‚¹ãƒãƒ›ã§ã®ã‚¿ãƒƒãƒ—åå¿œã‚’è‰¯ãã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ */
        .tap-active { transition: transform 0.1s ease; }
        .tap-active:active { transform: scale(0.97); }

        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ç”¨ */
        .input-field { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 16px; outline: none; transition: border 0.3s; background: white; -webkit-appearance: none; }
        .input-field:focus { border-color: #c5a178; box-shadow: 0 0 0 2px rgba(197, 161, 120, 0.2); }
        .btn-primary { width: 100%; padding: 14px; background-color: #c5a178; color: white; border-radius: 999px; font-weight: bold; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: opacity 0.3s, transform 0.1s; }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="bgBase">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // =================================================================
        // â˜…â˜…â˜… è¨­å®šå®Œäº†æ¸ˆã¿ã‚¨ãƒªã‚¢ï¼ˆå¤‰æ›´ä¸è¦ï¼‰ â˜…â˜…â˜…
        // =================================================================
        const LIFF_ID = "2008962877-6EjpZ2wZ";
        const AUTH_API_URL = "https://script.google.com/macros/s/AKfycbzs7E6JSktJ1SUzepLWnw6eQPGKH7VKrUz42FkvvYs_y7EiAdoxhWjgmd8oDCiWd_ti/exec"; 
        const DATA_API_URL = "https://script.google.com/macros/s/AKfycbxlqdGFsGAteMhVTA63JdGK3L_ySKgBP3SsOTLBvRoRnsisttyE3c5WJpkEcps51YCtqw/exec";
        const ELME_FORM_URL = "https://liff.line.me/2008962877-F6uzywmh?unique_key=MPpR55&ts=1769672204";
        // =================================================================

        const formatImageUrl = (url) => {
            if(!url) return null;
            let clean = url.trim();
            const idMatch = clean.match(/\/d\/(.+?)\/|id=(.+?)(&|$)/);
            if(clean.includes("drive.google") && idMatch) {
                const id = idMatch[1] || idMatch[2];
                return `https://lh3.googleusercontent.com/d/${id}`;
            }
            return clean;
        };

        const CATEGORY_THEMES = {
            "ã™ã¹ã¦": { main: "#c5a178", text: "#fff", dark: "#a1825e", badgeText: "#fff", sub: "#fff7e4" },
            "ã‚«ãƒ•ã‚§": { main: "#8d6e63", text: "#fff", dark: "#5d4037", badgeText: "#fff", sub: "#efebe9" },
            "é£²é£Ÿ": { main: "#fb923c", text: "#fff", dark: "#c2410c", badgeText: "#fff", sub: "#fff7ed" },
            "ç¾å®¹ãƒ»å¥åº·": { main: "#22d3ee", text: "#fff", dark: "#0e7490", badgeText: "#fff", sub: "#ecfeff" },
            "ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°": { main: "#ec4899", text: "#fff", dark: "#be185d", badgeText: "#fff", sub: "#fdf2f8" },
            "ã‚µãƒ¼ãƒ“ã‚¹": { main: "#10b981", text: "#fff", dark: "#047857", badgeText: "#fff", sub: "#ecfdf5" },
            "default": { main: "#c5a178", text: "#fff", dark: "#b08d66", badgeText: "#fff", sub: "#fff7e4" }
        };

        const getTheme = (category) => CATEGORY_THEMES[category] || CATEGORY_THEMES["default"];

        const Icon = ({ name, size = 20, className = "", style = {} }) => {
            const icons = {
                search: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
                mapPin: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>,
                heart: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>,
                heartFill: <svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>,
                arrowLeft: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>,
                externalLink: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>,
                home: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
                chevronRight: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>,
                x: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
                lock: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
            };
            return <span className={className} style={style}>{icons[name] || null}</span>;
        };

        const ImageCarousel = ({ images, shopName, theme }) => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const handleScroll = (e) => {
                const index = Math.round(e.target.scrollLeft / e.target.offsetWidth);
                setCurrentIndex(index);
            };

            if (!images || images.length === 0) {
                return (
                    <div className="w-full h-full flex items-center justify-center text-textLight flex-col color-transition" style={{ backgroundColor: theme.main }}>
                        <Icon name="mapPin" size={40} className="mb-2 opacity-30" />
                        <span className="text-sm font-bold opacity-50">No Image</span>
                    </div>
                );
            }

            return (
                <div className="relative w-full h-full group">
                    <div className="flex overflow-x-auto snap-x snap-mandatory h-full w-full hide-scrollbar" onScroll={handleScroll}>
                        {images.map((src, i) => (
                            <img key={i} src={src} onError={(e) => {e.target.style.display='none';}} alt={`${shopName} ${i+1}`} className="w-full h-full object-cover flex-shrink-0 snap-center bg-gray-100" />
                        ))}
                    </div>
                    {images.length > 1 && (
                        <div className="absolute bottom-4 left-0 right-0 flex justify-center space-x-2 z-10 pointer-events-none">
                            {images.map((_, i) => (
                                <div key={i} className={`w-2 h-2 rounded-full shadow-sm transition-all duration-300 ${i === currentIndex ? 'scale-125' : 'bg-white/70'}`} style={{ backgroundColor: i === currentIndex ? theme.dark : undefined }} />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ ---
        const LoginView = ({ onLoginSuccess }) => {
            const [companyId, setCompanyId] = useState("");
            const [employeeNo, setEmployeeNo] = useState("");
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [errorMsg, setErrorMsg] = useState("");

            const handleSubmit = async () => {
                if(!companyId || !employeeNo) return;
                setIsSubmitting(true);
                setErrorMsg("");

                try {
                    const profile = await liff.getProfile();
                    const res = await fetch(AUTH_API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ userId: profile.userId, companyId: companyId, employeeNo: employeeNo })
                    });
                    const json = await res.json();
                    
                    if (json.success) {
                        if (ELME_FORM_URL && ELME_FORM_URL.startsWith("http")) {
                            window.location.href = ELME_FORM_URL;
                        } else {
                            onLoginSuccess();
                        }
                    } else {
                        setErrorMsg(json.message || "èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
                    }
                } catch (e) {
                    console.error(e);
                    setErrorMsg("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-8 bg-bgBase animate-fade-in">
                    <div className="bg-white p-8 rounded-3xl shadow-lg w-full max-w-sm text-center">
                        <div className="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4 text-primary">
                            <Icon name="lock" size={32} />
                        </div>
                        <h1 className="text-xl font-bold text-textMain mb-2">ç¤¾å“¡èªè¨¼</h1>
                        <p className="text-sm text-textLight mb-6">åˆå›ã®ã¿èªè¨¼ãŒå¿…è¦ã§ã™ã€‚<br/>ä¼šç¤¾ã‹ã‚‰é…å¸ƒã•ã‚ŒãŸæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                        <div className="space-y-4 text-left">
                            <div><label className="text-xs font-bold text-textMain ml-1">ä¼šç¤¾ID</label><input type="text" className="input-field" placeholder="ä¾‹: ena" value={companyId} onChange={e => setCompanyId(e.target.value)} /></div>
                            <div><label className="text-xs font-bold text-textMain ml-1">ç¤¾å“¡ç•ªå·</label><input type="text" className="input-field" placeholder="ä¾‹: 001" value={employeeNo} onChange={e => setEmployeeNo(e.target.value)} /></div>
                        </div>
                        {errorMsg && <p className="text-red-500 text-xs mt-2 font-bold">{errorMsg}</p>}
                        <button onClick={handleSubmit} disabled={isSubmitting || !companyId || !employeeNo} className="btn-primary mt-6 shadow-md">
                            {isSubmitting ? 'èªè¨¼ä¸­...' : 'èªè¨¼ã—ã¦æ¬¡ã¸'}
                        </button>
                    </div>
                </div>
            );
        };

        // --- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª ---
        const App = () => {
            const [status, setStatus] = useState("loading"); 
            const [shops, setShops] = useState([]);
            // â˜…é‡è¦ä¿®æ­£ï¼šãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
            const [isDataLoaded, setIsDataLoaded] = useState(false);
            
            const [view, setView] = useState('list');
            const [selectedShop, setSelectedShop] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [selectedCategory, setSelectedCategory] = useState("ã™ã¹ã¦");
            const [isSearchOpen, setIsSearchOpen] = useState(false);
            const [favorites, setFavorites] = useState([]);
            const categoryTabsRef = useRef(null);
            
            const currentTheme = useMemo(() => getTheme(selectedCategory), [selectedCategory]);
            const categories = useMemo(() => ["ã™ã¹ã¦", ...Array.from(new Set(shops.map(s => s.category).filter(Boolean)))], [shops]);

            useEffect(() => {
                const init = async () => {
                    try {
                        if (typeof liff === 'undefined') throw new Error("LIFF SDK not loaded");
                        await liff.init({ liffId: LIFF_ID });
                        if (!liff.isLoggedIn()) { liff.login(); return; }
                        
                        const profile = await liff.getProfile();
                        const authRes = await fetch(`${AUTH_API_URL}?userId=${profile.userId}`);
                        const authJson = await authRes.json();

                        if (authJson.registered) {
                            setStatus("authorized");
                            // èªè¨¼OKãªã‚‰ãã®ã¾ã¾ãƒ‡ãƒ¼ã‚¿å–å¾—ã¸ç§»è¡Œï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯ç¶™ç¶šï¼‰
                            fetchShops();
                        } else {
                            setStatus("login");
                        }
                    } catch (e) {
                        console.error(e);
                        setStatus("login");
                    }
                };
                init();
            }, []);

            const fetchShops = async () => {
                try {
                    const savedFavs = JSON.parse(localStorage.getItem('myAppFavorites') || '[]');
                    setFavorites(savedFavs);
                    const res = await fetch(DATA_API_URL);
                    const data = await res.json();
                    setShops(data.map(item => ({
                        id: item.id, name: item.name, category: item.category, address: item.address, hours: item.hours, holiday: item.closed, phone: item.tel, website: item.url, sns: item.sns, note: item.description,
                        images: (item.image || "").split(',').filter(s => s.trim()).map(formatImageUrl),
                        couponImages: (item.coupon_imgs || "").split(',').filter(s => s.trim()).map(formatImageUrl),
                        couponUrls: (item.coupon_urls || "").split(',').map(s => s.trim()),
                        lat: item.lat, lng: item.lng
                    })));
                    
                    // â˜…ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå¾Œã«ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ï¼ˆã“ã“ã§åˆã‚ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è§£é™¤ï¼‰
                    setIsDataLoaded(true);
                    
                } catch(e) { 
                    console.error("Data load error", e);
                    // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯çµ‚ã‚ã‚‰ã›ã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã«ã™ã‚‹ã¨ãªãŠè‰¯ã„ï¼‰
                    setIsDataLoaded(true);
                }
            };

            // ã‚¨ãƒ«ãƒ¡ã¸é£›ã°ã›ãªã„å ´åˆã®äºˆå‚™å‹•ä½œ
            const handleLoginSuccess = async () => {
                setStatus("authorized");
                fetchShops();
            };

            const toggleFavorite = (id) => {
                const next = favorites.includes(id) ? favorites.filter(i => i !== id) : [...favorites, id];
                setFavorites(next);
                localStorage.setItem('myAppFavorites', JSON.stringify(next));
            };

            // ã‚¹ãƒ¯ã‚¤ãƒ—å‡¦ç†
            const [touchStart, setTouchStart] = useState(null);
            const [touchEnd, setTouchEnd] = useState(null);
            const onTouchStart = (e) => { setTouchEnd(null); setTouchStart({ x: e.targetTouches[0].clientX, y: e.targetTouches[0].clientY }); };
            const onTouchMove = (e) => { setTouchEnd({ x: e.targetTouches[0].clientX, y: e.targetTouches[0].clientY }); };
            const onTouchEnd = () => {
                if (!touchStart || !touchEnd) return;
                const distanceX = touchStart.x - touchEnd.x;
                const distanceY = touchStart.y - touchEnd.y;
                if (Math.abs(distanceX) > Math.abs(distanceY)) {
                    if (distanceX > 50 && categories.indexOf(selectedCategory) < categories.length - 1) setSelectedCategory(categories[categories.indexOf(selectedCategory) + 1]);
                    else if (distanceX < -50 && categories.indexOf(selectedCategory) > 0) setSelectedCategory(categories[categories.indexOf(selectedCategory) - 1]);
                }
                setTouchStart(null); setTouchEnd(null);
            };

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const filteredShops = useMemo(() => {
                let data = shops;
                if (view === 'favorites') data = data.filter(s => favorites.includes(s.id));
                if (selectedCategory !== "ã™ã¹ã¦") data = data.filter(s => s.category === selectedCategory);
                if (searchTerm) {
                    const low = searchTerm.toLowerCase();
                    data = data.filter(s => (s.name && s.name.toLowerCase().includes(low)) || (s.address && s.address.toLowerCase().includes(low)));
                }
                return data;
            }, [shops, view, selectedCategory, searchTerm, favorites]);

            const handleShopClick = (shop) => { setSelectedShop(shop); setView('detail'); window.scrollTo(0, 0); };
            const goHome = () => { setSelectedShop(null); setView('list'); setSearchTerm(""); setSelectedCategory("ã™ã¹ã¦"); setIsSearchOpen(false); };
            const goFavorites = () => { setSelectedShop(null); setView('favorites'); window.scrollTo(0, 0); setIsSearchOpen(false); };

            // â˜…ä¿®æ­£ï¼šãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°åˆ¤å®šã‚’å³å¯†åŒ–
            // statusãŒloadingã€ã¾ãŸã¯ï¼ˆauthorized ã ã‘ã© ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„ï¼‰å ´åˆã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            if (status === "loading" || (status === "authorized" && !isDataLoaded)) {
                return (
                    <div className="flex flex-col items-center justify-center h-screen bg-bgBase">
                        <div className="animate-spin text-primary w-10 h-10 border-4 border-current border-t-transparent rounded-full mb-4"></div>
                        <p className="text-textMain font-bold text-sm tracking-widest animate-pulse">LOADING...</p>
                    </div>
                );
            }

            if (status === "login") return <LoginView onLoginSuccess={handleLoginSuccess} />;

            // --- ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: ShopCard (ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ä¿®æ­£ç‰ˆ) ---
            const ShopCard = ({ shop }) => {
                const firstImage = (shop.images && shop.images.length > 0) ? shop.images[0] : null;
                const isFav = favorites.includes(shop.id);
                const theme = getTheme(shop.category);
                
                // â˜…ä¿®æ­£: ã‚¹ãƒãƒ›ã§ã®åå¿œã‚’è‰¯ãã™ã‚‹ãŸã‚ã€group/hoverç³»ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ã—ã€tap-activeã‚’è¿½åŠ 
                return (
                    <div 
                        onClick={() => handleShopClick(shop)} 
                        className="bg-white rounded-2xl shadow-sm overflow-hidden tap-active cursor-pointer flex flex-col h-full animate-pop-in border border-transparent"
                    >
                        <div className="h-32 md:h-48 w-full relative overflow-hidden" style={{ backgroundColor: theme.main }}>
                            {firstImage ? <img src={firstImage} alt={shop.name} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center" style={{ color: 'rgba(255,255,255,0.7)' }}><Icon name="mapPin" size={24} /></div>}
                            <button onClick={(e) => { e.stopPropagation(); toggleFavorite(shop.id); }} className="absolute top-2 right-2 bg-white/90 rounded-full p-2 shadow-md active:scale-90 transition-transform">
                                <Icon name={isFav ? "heartFill" : "heart"} size={18} style={{ color: isFav ? '#c5a178' : '#cbd5e1' }} />
                            </button>
                            <div className="absolute bottom-2 left-2 text-[10px] px-3 py-1 rounded-full font-bold shadow-md bg-white/90" style={{ color: theme.dark }}>{shop.category}</div>
                        </div>
                        <div className="p-3 flex-grow flex flex-col justify-between">
                            <div>
                                <h3 className="font-bold text-sm md:text-base mb-1 text-textMain leading-snug">{shop.name}</h3>
                                <div className="flex items-center text-textLight text-xs md:text-sm mb-2"><Icon name="mapPin" size={10} className="mr-1 flex-shrink-0" /><span className="truncate">{shop.address}</span></div>
                            </div>
                            <div className="mt-2 text-right">
                                <span className="text-xs md:text-sm border px-3 py-1.5 rounded-full font-bold shadow-sm inline-flex items-center" style={{ backgroundColor: theme.sub, borderColor: theme.main, color: theme.dark }}>è©³ç´° <Icon name="chevronRight" size={12} className="ml-1" /></span>
                            </div>
                        </div>
                    </div>
                );
            };

            // Detail View
            if (view === 'detail') {
                const theme = getTheme(selectedShop.category);
                const isFav = favorites.includes(selectedShop.id);
                const mapUrl = `https://www.google.com/maps/dir/?api=1&destination=${selectedShop.lat || ""},${selectedShop.lng || ""}`;
                return (
                    <div className="pb-40 animate-fade-in relative bg-white min-h-screen w-full md:max-w-4xl mx-auto shadow-2xl">
                        <button onClick={() => setView(view === 'favorites' ? 'favorites' : 'list')} className="fixed top-4 left-4 z-50 bg-white/90 backdrop-blur-md p-3 rounded-full shadow-lg transition border border-slate-100 color-transition text-textMain"><Icon name="arrowLeft" /></button>
                        <div className="relative h-72 md:h-96 w-full">
                            <ImageCarousel images={selectedShop.images} shopName={selectedShop.name} theme={theme} />
                            <div className="absolute inset-0 bg-gradient-to-t from-black/50 via-transparent to-black/10 pointer-events-none"></div>
                            <div className="absolute bottom-0 left-0 right-0 p-5 text-white pointer-events-none">
                                <span className="text-xs font-bold px-3 py-1 rounded-full mb-2 inline-block shadow-md" style={{ backgroundColor: theme.main, color: theme.badgeText }}>{selectedShop.category}</span>
                                <h1 className="text-2xl md:text-3xl font-bold leading-tight mb-1 shadow-black drop-shadow-md">{selectedShop.name}</h1>
                                <div className="flex items-center text-sm md:text-base text-white/95"><Icon name="mapPin" size={14} className="mr-1" />{selectedShop.address}</div>
                            </div>
                            <button onClick={(e) => { e.stopPropagation(); toggleFavorite(selectedShop.id); }} className="absolute bottom-5 right-5 p-3 rounded-full bg-white shadow-lg transform transition active:scale-90 z-20"><Icon name={isFav ? "heartFill" : "heart"} size={24} style={{ color: isFav ? '#c5a178' : '#cbd5e1' }} /></button>
                        </div>
                        <div className="px-4 md:px-8 py-6 space-y-6">
                            <div className="bg-white rounded-3xl shadow-sm p-6 border-2 color-transition" style={{ borderColor: theme.main }}>
                                <h2 className="text-lg font-bold mb-4 flex items-center color-transition" style={{ color: '#5d4037' }}><span className="w-2 h-6 rounded-full mr-2" style={{ backgroundColor: theme.main }}></span>åº—èˆ—æƒ…å ±</h2>
                                <div className="space-y-3 text-sm md:text-base text-textMain">
                                    <div className="flex border-b border-slate-100 pb-2"><span className="w-24 text-textLight font-medium flex-shrink-0">å–¶æ¥­æ™‚é–“</span><span>{selectedShop.hours}</span></div>
                                    <div className="flex border-b border-slate-100 pb-2"><span className="w-24 text-textLight font-medium flex-shrink-0">å®šä¼‘æ—¥</span><span>{selectedShop.holiday}</span></div>
                                    <div className="flex border-b border-slate-100 pb-2"><span className="w-24 text-textLight font-medium flex-shrink-0">é›»è©±ç•ªå·</span><a href={`tel:${selectedShop.phone}`} className="font-bold underline" style={{ color: theme.dark }}>{selectedShop.phone}</a></div>
                                    {selectedShop.website && <div className="flex border-b border-slate-100 pb-2"><span className="w-24 text-textLight font-medium flex-shrink-0">å…¬å¼ã‚µã‚¤ãƒˆ</span><a href={selectedShop.website} target="_blank" className="flex items-center hover:opacity-70" style={{ color: theme.dark }}>Webã‚µã‚¤ãƒˆ <Icon name="externalLink" size={12} className="ml-1" /></a></div>}
                                    {selectedShop.sns && <div className="flex border-b border-slate-100 pb-2"><span className="w-24 text-textLight font-medium flex-shrink-0">SNS</span><a href={selectedShop.sns} target="_blank" className="flex items-center hover:opacity-70" style={{ color: theme.dark }}>SNSã‚’è¦‹ã‚‹ <Icon name="externalLink" size={12} className="ml-1" /></a></div>}
                                    {selectedShop.note && <div className="flex pt-1"><span className="w-24 text-textLight font-medium flex-shrink-0">å‚™è€ƒ</span><span>{selectedShop.note}</span></div>}
                                </div>
                            </div>
                            {selectedShop.couponImages && selectedShop.couponImages.length > 0 && selectedShop.couponImages[0] !== "" && (
                                <div className="space-y-4">
                                    {selectedShop.couponImages.map((img, idx) => (
                                        <div key={idx} className="coupon-ticket text-center p-6 rounded-2xl shadow-sm border-2 color-transition" style={{ borderColor: theme.main, background: `linear-gradient(to bottom right, #fff, ${theme.main}22)` }}>
                                            <h3 className="text-lg font-bold mb-3 flex items-center justify-center color-transition" style={{ color: '#5d4037' }}><span className="text-2xl mr-2">ğŸ</span> ç‰¹åˆ¥ã‚¯ãƒ¼ãƒãƒ³ {selectedShop.couponImages.length > 1 ? `(${idx+1})` : ""}</h3>
                                            <div className="rounded-xl overflow-hidden border border-slate-200 mb-4 bg-white shadow-inner"><img src={img} alt="Coupon" className="w-full h-auto" onError={(e) => e.target.style.display='none'} /></div>
                                            {selectedShop.couponUrls[idx] && selectedShop.couponUrls[idx] !== "#" && selectedShop.couponUrls[idx] !== "" ? (
                                                <a href={selectedShop.couponUrls[idx]} target="_blank" className="block w-full text-white font-bold py-4 rounded-full shadow-lg transform transition active:scale-95 text-lg color-transition hover:opacity-90" style={{ backgroundColor: theme.dark }}>ã“ã®ã‚¯ãƒ¼ãƒãƒ³ã‚’ä½¿ã†</a>
                                            ) : (
                                                <button disabled className="w-full bg-slate-300 text-white font-bold py-4 rounded-full cursor-not-allowed">åº—é ­ã§æç¤ºã®ã¿</button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        <div className="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-md border-t border-slate-100 z-50 safe-area-bottom md:max-w-4xl md:mx-auto">
                            <a href={mapUrl} target="_blank" className="block w-full text-white font-bold py-3.5 rounded-xl shadow-lg text-center flex items-center justify-center transition active:scale-95 color-transition hover:opacity-90" style={{ backgroundColor: theme.dark }}><Icon name="mapPin" className="mr-2" />ã“ã“ã¸è¡Œãï¼ˆãƒ«ãƒ¼ãƒˆæ¡ˆå†…ï¼‰</a>
                        </div>
                    </div>
                );
            }

            return (
                <div className="pb-24 w-full md:max-w-7xl mx-auto min-h-screen relative bg-bgBase animate-fade-in">
                    <div className="sticky top-0 z-30 shadow-sm text-white rounded-b-[2rem] mb-4 color-transition" style={{ backgroundColor: currentTheme.main }}>
                        <div className="px-5 pt-3 pb-1">
                            <div className="flex justify-between items-center py-1">
                                <div><h1 className="text-xl md:text-2xl font-bold tracking-wide flex items-center color-transition" style={{ color: currentTheme.text }}>{view === 'favorites' ? 'ãŠæ°—ã«å…¥ã‚Š' : 'åŠ ç›Ÿåº—ä¸€è¦§'}{view !== 'favorites' && (<span className="ml-3 text-xs px-2 py-0.5 rounded-full font-bold color-transition border border-white/20" style={{ backgroundColor: 'rgba(255,255,255,0.3)', color: currentTheme.text }}>{filteredShops.length}ä»¶</span>)}</h1></div>
                                {view !== 'favorites' && <button onClick={() => setIsSearchOpen(!isSearchOpen)} className="p-2 rounded-full transition-colors duration-200 color-transition hover:bg-white/30" style={{ backgroundColor: isSearchOpen ? 'white' : 'transparent', color: isSearchOpen ? currentTheme.main : currentTheme.text }}><Icon name={isSearchOpen ? "x" : "search"} size={22} /></button>}
                            </div>
                            {view !== 'favorites' && (
                                <div className={`overflow-hidden transition-all duration-300 ease-in-out ${isSearchOpen ? 'max-h-20 opacity-100 mt-3' : 'max-h-0 opacity-0'}`}>
                                    <div className="relative mb-2">
                                        <input type="text" placeholder="åº—åãƒ»ä½æ‰€ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢..." className="w-full bg-white/90 border-none rounded-full py-2.5 pl-10 pr-4 text-sm focus:ring-2 shadow-inner placeholder-textLight outline-none color-transition" style={{ color: '#5d4037', '--tw-ring-color': currentTheme.dark }} value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                        <div className="absolute left-3.5 top-2.5 text-textLight"><Icon name="search" size={18} /></div>
                                    </div>
                                </div>
                            )}
                        </div>
                        {view !== 'favorites' && (
                            <div className="px-4 pb-4">
                                <div className="flex space-x-2 overflow-x-auto hide-scrollbar" ref={categoryTabsRef}>
                                    {categories.map(cat => {
                                        const isActive = selectedCategory === cat;
                                        const theme = getTheme(cat);
                                        return <button key={cat} data-category={cat} onClick={() => setSelectedCategory(cat)} className={`whitespace-nowrap px-5 py-2 rounded-full text-sm font-bold transition-all border-2 ${selectedCategory === cat ? 'scale-105 shadow-md' : ''}`} style={{ backgroundColor: selectedCategory === cat ? theme.badgeText : 'transparent', color: selectedCategory === cat ? (theme.badgeText === '#fff' ? theme.main : theme.text) : theme.text, borderColor: selectedCategory === cat ? 'transparent' : 'rgba(255,255,255,0.6)' }}>{cat}</button>;
                                    })}
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="px-4 md:px-6 min-h-[50vh]" onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4 md:gap-6 animate-slide-in">
                            {filteredShops.length > 0 ? (filteredShops.map(shop => <ShopCard key={shop.id} shop={shop} />)) : (
                                <div className="col-span-2 md:col-span-3 text-center py-20 text-textLight animate-fade-in">
                                    <div className="mb-4 flex justify-center opacity-30"><Icon name="search" size={64} /></div>
                                    <p className="text-lg font-bold opacity-70 color-transition" style={{ color: '#5d4037' }}>ãŠåº—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“...</p>
                                    <p className="text-xs mt-1">æ¤œç´¢æ¡ä»¶ã‚’å¤‰ãˆã¦ã¿ã¦ãã ã•ã„</p>
                                    {view !== 'favorites' && (<button onClick={() => {setSearchTerm(""); setSelectedCategory("ã™ã¹ã¦");}} className="mt-4 text-sm underline color-transition" style={{ color: currentTheme.dark }}>æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢ã—ã¦å…¨ã¦è¡¨ç¤º</button>)}
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-white/95 backdrop-blur-md rounded-full shadow-2xl border border-slate-100 flex px-10 py-3 z-40 space-x-16 items-center">
                        <button onClick={goHome} className={`flex flex-col items-center justify-center transition duration-300 transform ${view === 'list' ? 'scale-110' : 'hover:opacity-70'}`} style={{ color: view === 'list' ? currentTheme.main : '#8d7b75' }}><Icon name="home" size={26} /><span className="text-[10px] mt-0.5 font-bold">ãƒ›ãƒ¼ãƒ </span></button>
                        <button onClick={goFavorites} className={`flex flex-col items-center justify-center transition duration-300 transform ${view === 'favorites' ? 'scale-110' : 'hover:opacity-70'}`} style={{ color: view === 'favorites' ? '#f472b6' : '#8d7b75' }}><Icon name={view === 'favorites' ? "heartFill" : "heart"} size={26} /><span className="text-[10px] mt-0.5 font-bold">ãŠæ°—ã«å…¥ã‚Š</span></button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
