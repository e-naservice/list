<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>åŠ ç›Ÿåº—ä¸€è¦§</title>

    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bgBase: '#fff7e4',
                        primary: '#c5a178',
                        textMain: '#5d4037',
                        textLight: '#8d7b75',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'pop-in': 'popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'heart-bounce': 'heartBounce 0.3s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        slideIn: { '0%': { opacity: '0', transform: 'translateX(20px)' }, '100%': { opacity: '1', transform: 'translateX(0)' } },
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        heartBounce: { '0%, 100%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.3)' } }
                    }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; background-color: #fff7e4; color: #5d4037; -webkit-font-smoothing: antialiased; overscroll-behavior-y: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .coupon-ticket { background: #ffffff; position: relative; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05)); clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 95% 95%, 90% 100%, 85% 95%, 80% 100%, 75% 95%, 70% 100%, 65% 95%, 60% 100%, 55% 95%, 50% 100%, 45% 95%, 40% 100%, 35% 95%, 30% 100%, 25% 95%, 20% 100%, 15% 95%, 10% 100%, 5% 95%, 0% 100%); padding-bottom: 30px; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .color-transition { transition: all 0.4s ease; }
        .shop-card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .shop-card-hover:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bgBase">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const LIFF_ID = "2008962877-6EjpZ2wZ";
        
        // â˜…â˜…â˜… 2ã¤ã®URLã‚’ä½¿ã„åˆ†ã‘ã¾ã™ â˜…â˜…â˜…
        // 1. èªè¨¼ãƒã‚§ãƒƒã‚¯ç”¨GASï¼ˆä»Šå›ä½œã£ãŸã‚‚ã®ï¼šå…¥ã‚Šå£ã®é–€ç•ªï¼‰
        const AUTH_API_URL = "https://script.google.com/macros/s/AKfycbwyFkNBigDdwQrmRD0Qm6FnbS7o8bqUT8jK7yrKNrx1b95TDS4CD3Sm063UIeXwp9LExg/exec";
        
        // 2. åŠ ç›Ÿåº—ãƒ‡ãƒ¼ã‚¿å–å¾—ç”¨GASï¼ˆå…ƒã€…ã‚ã£ãŸã‚‚ã®ï¼šãƒ‡ãƒ¼ã‚¿ã®ãŠçš¿ï¼‰
        const DATA_API_URL = "https://script.google.com/macros/s/AKfycbxlqdGFsGAteMhVTA63JdGK3L_ySKgBP3SsOTLBvRoRnsisttyE3c5WJpkEcps51YCtqw/exec";

        // --- ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ†ãƒ¼ãƒå®šç¾© ---
        const CATEGORY_THEMES = {
            "ã™ã¹ã¦": { main: "#c5a178", text: "#fff", dark: "#a1825e", badgeText: "#fff", sub: "#fff7e4" },
            "ã‚«ãƒ•ã‚§": { main: "#8d6e63", text: "#fff", dark: "#5d4037", badgeText: "#fff", sub: "#efebe9" },
            "é£²é£Ÿ": { main: "#fb923c", text: "#fff", dark: "#c2410c", badgeText: "#fff", sub: "#fff7ed" },
            "ç¾å®¹ãƒ»å¥åº·": { main: "#22d3ee", text: "#fff", dark: "#0e7490", badgeText: "#fff", sub: "#ecfeff" },
            "ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°": { main: "#ec4899", text: "#fff", dark: "#be185d", badgeText: "#fff", sub: "#fdf2f8" },
            "ã‚µãƒ¼ãƒ“ã‚¹": { main: "#10b981", text: "#fff", dark: "#047857", badgeText: "#fff", sub: "#ecfdf5" },
            "default": { main: "#c5a178", text: "#fff", dark: "#b08d66", badgeText: "#fff", sub: "#fff7e4" }
        };

        const getTheme = (cat) => CATEGORY_THEMES[cat] || CATEGORY_THEMES["default"];

        const Icon = ({ name, size = 20, className = "", style = {} }) => {
            const icons = {
                search: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
                mapPin: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>,
                heart: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>,
                heartFill: <svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>,
                arrowLeft: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>,
                home: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
                chevronRight: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><polyline points="9 18 15 12 9 6"></polyline></svg>,
                x: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
                lock: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
            };
            return icons[name] || null;
        };

        const App = () => {
            const [shops, setShops] = useState([]);
            // status: 'loading' | 'allowed' | 'denied' | 'error_browser' | 'error_net'
            const [status, setStatus] = useState("loading");
            const [view, setView] = useState('list');
            const [selectedShop, setSelectedShop] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [selectedCategory, setSelectedCategory] = useState("ã™ã¹ã¦");
            const [isSearchOpen, setIsSearchOpen] = useState(false);
            const [favorites, setFavorites] = useState([]);

            const currentTheme = useMemo(() => getTheme(selectedCategory), [selectedCategory]);

            // --- LIFF & Data Initializer ---
            useEffect(() => {
                const init = async () => {
                    try {
                        await liff.init({ liffId: LIFF_ID });
                        
                        // 1. ãƒ–ãƒ©ã‚¦ã‚¶ãƒã‚§ãƒƒã‚¯: LINEã‚¢ãƒ—ãƒªå¤–ãªã‚‰NG
                        if (!liff.isInClient()) {
                            setStatus("error_browser");
                            return;
                        }

                        // 2. ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯: æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰å¼·åˆ¶ãƒ­ã‚°ã‚¤ãƒ³
                        if (!liff.isLoggedIn()) {
                            liff.login();
                            return;
                        }

                        // 3. â˜…èªè¨¼ãƒã‚§ãƒƒã‚¯: èªè¨¼ç”¨GASã«å•ã„åˆã‚ã›ã‚‹
                        const profile = await liff.getProfile();
                        const authRes = await fetch(`${AUTH_API_URL}?uid=${profile.userId}`);
                        const authResult = await authRes.json();

                        if (!authResult.allowed) {
                            // è¨±å¯ãƒªã‚¹ãƒˆã«ãªã„ã€ã¾ãŸã¯é€€è·æ¸ˆã¿
                            setStatus("denied");
                            return;
                        }

                        // 4. â˜…ãƒ‡ãƒ¼ã‚¿å–å¾—: èªè¨¼OKã®å ´åˆã®ã¿ã€åŠ ç›Ÿåº—ãƒ‡ãƒ¼ã‚¿ç”¨GASã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚‹
                        const saved = JSON.parse(localStorage.getItem('myAppFavorites') || '[]');
                        setFavorites(saved);

                        const dataRes = await fetch(DATA_API_URL);
                        const data = await dataRes.json();
                        
                        setShops(data.map(item => ({
                            id: item.id,
                            name: item.name,
                            category: item.category,
                            address: item.address,
                            hours: item.hours,
                            holiday: item.closed,
                            phone: item.tel,
                            website: item.url,
                            sns: item.sns,
                            note: item.description,
                            images: (item.image || "").split(',').filter(s => s.trim()),
                            couponImages: (item.coupon_imgs || "").split(',').filter(s => s.trim()),
                            couponUrls: (item.coupon_urls || "").split(',').map(s => s.trim()),
                            lat: item.lat,
                            lng: item.lng
                        })));

                        // å…¨ã¦å®Œäº†ã—ãŸã‚‰è¡¨ç¤ºè¨±å¯
                        setStatus("allowed");

                    } catch (e) {
                        console.error(e);
                        setStatus("error_net");
                    }
                };
                init();
            }, []);

            const toggleFavorite = (id) => {
                const next = favorites.includes(id) ? favorites.filter(i => i !== id) : [...favorites, id];
                setFavorites(next);
                localStorage.setItem('myAppFavorites', JSON.stringify(next));
            };

            const filteredShops = useMemo(() => {
                let d = view === 'favorites' ? shops.filter(s => favorites.includes(s.id)) : shops;
                if (selectedCategory !== "ã™ã¹ã¦") d = d.filter(s => s.category === selectedCategory);
                if (searchTerm) {
                    const low = searchTerm.toLowerCase();
                    d = d.filter(s => s.name?.toLowerCase().includes(low) || s.address?.toLowerCase().includes(low));
                }
                return d;
            }, [shops, view, selectedCategory, searchTerm, favorites]);


            // --- ç”»é¢ã®å‡ºã—åˆ†ã‘ (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ & ã‚¨ãƒ©ãƒ¼) ---

            if (status === "loading") return (
                <div className="flex flex-col items-center justify-center h-screen bg-bgBase">
                    <div className="animate-spin text-primary w-10 h-10 border-4 border-current border-t-transparent rounded-full mb-4"></div>
                    <p className="font-bold text-textMain tracking-widest">èªè¨¼ä¸­...</p>
                </div>
            );

            if (status === "denied") return (
                <div className="flex flex-col items-center justify-center h-screen bg-bgBase p-6 text-center animate-fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-lg border-2 border-red-100 max-w-sm w-full">
                        <div className="text-red-500 mb-4 flex justify-center"><Icon name="lock" size={48} /></div>
                        <h2 className="text-xl font-bold text-textMain mb-4">åˆ©ç”¨ã§ãã¾ã›ã‚“</h2>
                        <p className="text-textLight text-sm leading-relaxed">
                            ä¼šå“¡ç™»éŒ²ãŒå®Œäº†ã—ã¦ã„ãªã„ã‹ã€<br/>
                            ç¤¾å“¡æƒ…å ±ãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™ã€‚<br/><br/>
                            æ‰€å±åº—èˆ—ã®ç®¡ç†è€…ã«<br/>ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
                        </p>
                    </div>
                </div>
            );

            if (status === "error_browser") return (
                <div className="flex items-center justify-center h-screen bg-bgBase p-4 text-center font-bold text-textMain">
                    ã“ã®ãƒšãƒ¼ã‚¸ã¯LINEã‚¢ãƒ—ãƒªã‹ã‚‰ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™
                </div>
            );

            if (status === "error_net") return (
                <div className="flex items-center justify-center h-screen bg-bgBase p-4 text-center font-bold text-textMain">
                    é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br/>å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚
                </div>
            );


            // --- ä»¥ä¸‹ã€èªè¨¼OKã®å ´åˆã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª ---

            // --- Detail View Component ---
            const Detail = ({ shop }) => {
                const theme = getTheme(shop.category);
                const isFav = favorites.includes(shop.id);
                // å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ç¦æ­¢ã®ãŸã‚é€šå¸¸ã®aã‚¿ã‚°ã§ã¯ãªãLINEå†…ãƒ–ãƒ©ã‚¦ã‚¶ç¶­æŒã‚’ç¢ºèª
                return (
                    <div className="pb-40 animate-fade-in bg-white min-h-screen">
                        <button onClick={() => setView('list')} className="fixed top-4 left-4 z-50 bg-white/90 p-3 rounded-full shadow-lg"><Icon name="arrowLeft" /></button>
                        <div className="relative h-72 md:h-96 w-full bg-slate-200">
                            {shop.images[0] && <img src={shop.images[0]} className="w-full h-full object-cover" />}
                            <div className="absolute bottom-0 p-5 text-white bg-gradient-to-t from-black/60 w-full">
                                <span className="text-xs px-2 py-1 rounded-full bg-primary" style={{backgroundColor: theme.main}}>{shop.category}</span>
                                <h1 className="text-2xl font-bold mt-2">{shop.name}</h1>
                            </div>
                        </div>
                        <div className="p-5 space-y-6">
                            <div className="p-5 border-2 rounded-2xl" style={{borderColor: theme.main}}>
                                <h2 className="font-bold mb-3">åº—èˆ—æƒ…å ±</h2>
                                <div className="text-sm space-y-2">
                                    <p><span className="text-textLight w-20 inline-block">ä½æ‰€</span>{shop.address}</p>
                                    <p><span className="text-textLight w-20 inline-block">å–¶æ¥­æ™‚é–“</span>{shop.hours}</p>
                                    <p><span className="text-textLight w-20 inline-block">å®šä¼‘æ—¥</span>{shop.holiday}</p>
                                    {shop.phone && <p><span className="text-textLight w-20 inline-block">é›»è©±</span><a href={`tel:${shop.phone}`} className="font-bold" style={{color: theme.dark}}>{shop.phone}</a></p>}
                                </div>
                            </div>
                            {shop.couponImages.length > 0 && (
                                <div className="coupon-ticket p-6 border-2 rounded-2xl text-center" style={{borderColor: theme.main}}>
                                    <h3 className="font-bold mb-3">ğŸ ç‰¹åˆ¥ã‚¯ãƒ¼ãƒãƒ³</h3>
                                    <img src={shop.couponImages[0]} className="w-full rounded-lg mb-4" />
                                    <button className="w-full py-4 rounded-full text-white font-bold" style={{backgroundColor: theme.dark}}>åº—é ­ã§æç¤ºã—ã¦ãã ã•ã„</button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            if (view === 'detail') return <Detail shop={selectedShop} />;

            return (
                <div className="pb-24 min-h-screen bg-bgBase animate-fade-in">
                    <div className="sticky top-0 z-30 p-5 text-white rounded-b-[2rem] shadow-md" style={{backgroundColor: currentTheme.main}}>
                        <div className="flex justify-between items-center">
                            <h1 className="text-xl font-bold">{view === 'favorites' ? 'ãŠæ°—ã«å…¥ã‚Š' : 'åŠ ç›Ÿåº—ä¸€è¦§'}</h1>
                            <button onClick={() => setIsSearchOpen(!isSearchOpen)} className="p-2 bg-white/20 rounded-full"><Icon name={isSearchOpen ? "x" : "search"} /></button>
                        </div>
                        {isSearchOpen && (
                            <input 
                                type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)}
                                placeholder="åº—åã§æ¤œç´¢..." className="w-full mt-4 p-3 rounded-full text-textMain outline-none"
                            />
                        )}
                        <div className="flex space-x-2 overflow-x-auto mt-4 hide-scrollbar">
                            {["ã™ã¹ã¦", "ã‚«ãƒ•ã‚§", "é£²é£Ÿ", "ç¾å®¹ãƒ»å¥åº·", "ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°", "ã‚µãƒ¼ãƒ“ã‚¹"].map(cat => (
                                <button key={cat} onClick={() => setSelectedCategory(cat)} 
                                    className={`px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border ${selectedCategory === cat ? 'bg-white text-primary' : 'border-white/50'}`}>
                                    {cat}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="p-4 grid grid-cols-2 gap-4">
                        {filteredShops.map(s => (
                            <div key={s.id} onClick={() => {setSelectedShop(s); setView('detail'); window.scrollTo(0,0);}} className="bg-white rounded-2xl overflow-hidden shadow-sm shop-card-hover">
                                <div className="h-32 bg-slate-100 relative">
                                    {s.images[0] && <img src={s.images[0]} className="w-full h-full object-cover" />}
                                    <button onClick={(e) => {e.stopPropagation(); toggleFavorite(s.id);}} className="absolute top-2 right-2 p-1.5 bg-white/80 rounded-full">
                                        <Icon name={favorites.includes(s.id) ? "heartFill" : "heart"} size={16} style={{color: favorites.includes(s.id) ? '#c5a178' : '#ccc'}} />
                                    </button>
                                </div>
                                <div className="p-3">
                                    <h3 className="text-sm font-bold truncate">{s.name}</h3>
                                    <p className="text-[10px] text-textLight truncate">{s.address}</p>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/95 backdrop-blur-md rounded-full shadow-2xl flex px-10 py-3 z-40 space-x-16 border border-slate-100">
                        <button onClick={() => {setView('list'); window.scrollTo(0,0);}} className="flex flex-col items-center" style={{color: view === 'list' ? currentTheme.main : '#8d7b75'}}>
                            <Icon name="home" size={24} /><span className="text-[10px] font-bold">ãƒ›ãƒ¼ãƒ </span>
                        </button>
                        <button onClick={() => {setView('favorites'); window.scrollTo(0,0);}} className="flex flex-col items-center" style={{color: view === 'favorites' ? '#f472b6' : '#8d7b75'}}>
                            <Icon name={view === 'favorites' ? "heartFill" : "heart"} size={24} /><span className="text-[10px] font-bold">ãŠæ°—ã«å…¥ã‚Š</span>
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
