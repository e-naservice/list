<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>加盟店一覧</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { bgBase: '#fff7e4', primary: '#c5a178', textMain: '#5d4037', textLight: '#8d7b75' }, animation: { 'fade-in': 'fadeIn 0.4s ease-out' }, keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } } } } }
    </script>
    <style>
        body { font-family: sans-serif; background-color: #fff7e4; color: #5d4037; overscroll-behavior-y: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bgBase">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const LIFF_ID = "2008962877-6EjpZ2wZ"; 
        
        // ★門番(AUTH_API)は削除しました。データ取得用URLのみ使用します。
        const DATA_API_URL = "https://script.google.com/macros/s/AKfycbxlqdGFsGAteMhVTA63JdGK3L_ySKgBP3SsOTLBvRoRnsisttyE3c5WJpkEcps51YCtqw/exec";

        const CATEGORY_THEMES = { "すべて": { main: "#c5a178" }, "カフェ": { main: "#8d6e63" }, "飲食": { main: "#fb923c" }, "美容・健康": { main: "#22d3ee" }, "ショッピング": { main: "#ec4899" }, "サービス": { main: "#10b981" }, "default": { main: "#c5a178" } };
        const getTheme = (cat) => CATEGORY_THEMES[cat] || CATEGORY_THEMES["default"];

        const Icon = ({ name }) => {
            const icons = {
                search: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
                arrowLeft: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>,
                home: <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
                x: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            };
            return icons[name] || null;
        };

        const App = () => {
            const [shops, setShops] = useState([]);
            const [view, setView] = useState('list'); // list | detail
            const [selectedShop, setSelectedShop] = useState(null);
            const [selectedCategory, setSelectedCategory] = useState("すべて");
            const [searchTerm, setSearchTerm] = useState("");
            const [isSearchOpen, setIsSearchOpen] = useState(false);

            useEffect(() => {
                const init = async () => {
                    await liff.init({ liffId: LIFF_ID }).catch(console.error);
                    // 誰でもデータを取りに行く
                    fetch(DATA_API_URL)
                        .then(res => res.json())
                        .then(data => {
                            setShops(data.map(item => ({
                                id: item.id,
                                name: item.name,
                                category: item.category,
                                address: item.address,
                                hours: item.hours,
                                images: (item.image || "").split(',').filter(s => s.trim()),
                                couponImages: (item.coupon_imgs || "").split(',').filter(s => s.trim()),
                            })));
                        })
                        .catch(err => console.error("Data Load Error:", err));
                };
                init();
            }, []);

            const filteredShops = shops.filter(s => {
                const matchCat = selectedCategory === "すべて" || s.category === selectedCategory;
                const matchSearch = !searchTerm || s.name.includes(searchTerm) || s.address.includes(searchTerm);
                return matchCat && matchSearch;
            });

            if (view === 'detail' && selectedShop) {
                const theme = getTheme(selectedShop.category);
                return (
                    <div className="pb-20 bg-white min-h-screen">
                        <button onClick={() => setView('list')} className="fixed top-4 left-4 z-50 bg-white/90 p-3 rounded-full shadow-lg"><Icon name="arrowLeft" /></button>
                        <div className="relative h-72 bg-slate-200">
                            {selectedShop.images[0] && <img src={selectedShop.images[0]} className="w-full h-full object-cover" />}
                            <div className="absolute bottom-0 p-4 text-white bg-gradient-to-t from-black/60 w-full">
                                <span className="text-xs px-2 py-1 rounded-full" style={{backgroundColor: theme.main}}>{selectedShop.category}</span>
                                <h1 className="text-2xl font-bold mt-1">{selectedShop.name}</h1>
                            </div>
                        </div>
                        <div className="p-5 space-y-4">
                            <div className="p-4 border rounded-xl">
                                <h2 className="font-bold mb-2">店舗情報</h2>
                                <p className="text-sm">{selectedShop.address}</p>
                                <p className="text-sm mt-1">{selectedShop.hours}</p>
                            </div>
                            {selectedShop.couponImages[0] && <img src={selectedShop.couponImages[0]} className="w-full rounded-xl" />}
                        </div>
                    </div>
                );
            }

            return (
                <div className="pb-24 min-h-screen bg-bgBase">
                    <div className="sticky top-0 z-30 p-5 text-white rounded-b-[2rem] shadow-md" style={{backgroundColor: getTheme(selectedCategory).main}}>
                        <div className="flex justify-between items-center">
                            <h1 className="text-xl font-bold">加盟店一覧</h1>
                            <button onClick={() => setIsSearchOpen(!isSearchOpen)} className="p-2 bg-white/20 rounded-full"><Icon name={isSearchOpen ? "x" : "search"} /></button>
                        </div>
                        {isSearchOpen && <input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full mt-4 p-3 rounded-full text-textMain outline-none" placeholder="検索..." />}
                        <div className="flex space-x-2 overflow-x-auto mt-4 hide-scrollbar">
                            {["すべて", "カフェ", "飲食", "美容・健康", "ショッピング", "サービス"].map(cat => (
                                <button key={cat} onClick={() => setSelectedCategory(cat)} className={`px-4 py-1 rounded-full text-xs font-bold whitespace-nowrap border ${selectedCategory === cat ? 'bg-white text-primary' : 'border-white/50'}`}>{cat}</button>
                            ))}
                        </div>
                    </div>
                    <div className="p-4 grid grid-cols-2 gap-4">
                        {filteredShops.map(s => (
                            <div key={s.id} onClick={() => {setSelectedShop(s); setView('detail');}} className="bg-white rounded-2xl overflow-hidden shadow-sm">
                                <div className="h-32 bg-slate-100">{s.images[0] && <img src={s.images[0]} className="w-full h-full object-cover" />}</div>
                                <div className="p-3"><h3 className="text-sm font-bold truncate">{s.name}</h3><p className="text-[10px] text-textLight truncate">{s.address}</p></div>
                            </div>
                        ))}
                    </div>
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/95 rounded-full shadow-xl flex px-10 py-3 z-40">
                        <button onClick={() => setView('list')} className="flex flex-col items-center text-primary"><Icon name="home" /><span className="text-[10px]">ホーム</span></button>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
